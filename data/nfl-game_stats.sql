-- Author:  Christopher Mortimer
-- Date:    2019-10-21
-- Desc:    Import a CSV file to SQL server using the BULK INSERT
-- Usage:   from a Windows Powershell session
--			Invoke-Sqlcmd -InputFile "nfl-game_stats.sql" -ServerInstance "localhost\SQLEXPRESS" | Out-File -FilePath "nfl-game_stats.txt"

SELECT GETDATE() AS TimeOfQuery
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Create table
CREATE TABLE [PRD_LA_NFL].[DBO].[GAME_STATS] (
	[GAME_ID] VARCHAR(50)
	, [TEAM_ID] VARCHAR(50)
	, [TOTAL_FIRST_DOWNS] VARCHAR(50)
	, [PASSING_FIRST_DOWNS] VARCHAR(50)
	, [RUSHING_FIRST_DOWNS] VARCHAR(50)
	, [PENALTY_FIRST_DOWNS] VARCHAR(50)
	, [THIRD_DOWN_ATTEMPTS] VARCHAR(50)
	, [THIRD_DOWN_CONVERSIONS] VARCHAR(50)
	, [THIRD_DOWN_CONVERSION_PERC] DECIMAL(10,5)
	, [THIRD_DOWN_PASSING_CONVERSIONS] VARCHAR(50)
	, [THIRD_DOWN_RUSHING_CONVERSIONS] VARCHAR(50)
	, [THIRD_DOWN_PENALTY_CONVERSIONS] VARCHAR(50)
	, [FOURTH_DOWN_ATTEMPTS] VARCHAR(50)
	, [FOURTH_DOWN_CONVERSIONS] VARCHAR(50)
	, [FOURTH_DOWN_CONVERSION_PERC] VARCHAR(50)
	, [FOURTH_DOWN_PASSING_CONVERSIONS] VARCHAR(50)
	, [FOURTH_DOWN_RUSHING_CONVERSIONS] VARCHAR(50)
	, [FOURTH_DOWN_PENALTY_CONVERSIONS] VARCHAR(50)
	, [TOTAL_PLAYS] VARCHAR(50)
	, [TOTAL_YARDS] VARCHAR(50)
	, [YARDS_PER_PLAY] VARCHAR(50)
	, [RUSHING_PLAYS] VARCHAR(50)
	, [RUSHING_YARDS] VARCHAR(50)
	, [RUSHING_YARDS_PER_PLAY] VARCHAR(50)
	, [PASSING_PLAYS] VARCHAR(50)
	, [PASSING_COMPLETIONS] VARCHAR(50)
	, [PASSING_YARDS_PER_PLAY] VARCHAR(50)
	, [INTERCEPTIONS] VARCHAR(50)
	, [SACKS] VARCHAR(50)
	, [NET_PASSING_YARDS] VARCHAR(50)
	, [GROSS_PASSING_YARDS] VARCHAR(50)
	, [SACK_YARDS] VARCHAR(50)
	, [TOTAL_RETURN_YARDS] VARCHAR(50)
	, [PUNT_RETURNS] VARCHAR(50)
	, [PUNT_RETURN_YARDS] VARCHAR(50)
	, [KICK_OFF_RETURNS] VARCHAR(50)
	, [KICK_OFF_RETURN_YARDS] VARCHAR(50)
	, [INTERCEPTION_RETURNS] VARCHAR(50)
	, [INTERCEPTION_RETURN_YARDS] VARCHAR(50)
	, [KICK_OFFS] VARCHAR(50)
	, [KICK_OFFS_IN_ENDZONE] VARCHAR(50)
	, [TOUCHBACKS] VARCHAR(50)
	, [PUNTS] VARCHAR(50)
	, [AVERAGE_PUNT_YARDS] VARCHAR(50)
	, [PUNTS_BLOCKED] VARCHAR(50)
	, [AVERAGE_NET_PUNT_YARDS] VARCHAR(50)
	, [PENALTIES] VARCHAR(50)
	, [PENALTY_YARDS] VARCHAR(50)
	, [FUMBLES] VARCHAR(50)
	, [FUMBLES_LOST] VARCHAR(50)
	, [TOTAL_TD] VARCHAR(50)
	, [PASSING_TD] VARCHAR(50)
	, [RUSHING_TD] VARCHAR(50)
	, [INTERCEPTION_TD] VARCHAR(50)
	, [FUMBLE_TD] VARCHAR(50)
	, [PUNT_RETURN_TD] VARCHAR(50)
	, [KICK_OFF_RETURN_TD] VARCHAR(50)
	, [FIELD_GOAL_RETURN_TD] VARCHAR(50)
	, [EXTRA_POINT_ATTEMPTS] VARCHAR(50)
	, [EXTRA_POINTS_MADE] VARCHAR(50)
	, [EXTRA_POINTS_BLOCKED] VARCHAR(50)
	, [TWO_POINT_CONVERSION_ATTEMPTS] VARCHAR(50)
	, [TWO_POINT_CONVERSIONS_MADE] VARCHAR(50)
	, [FIELD_GOAL_ATTEMPTS] VARCHAR(50)
	, [FIELD_GOALS_MADE] VARCHAR(50)
	, [FIELD_GOALS_BLOCKED] VARCHAR(50)
	, [REDZONE_VISITS] VARCHAR(50)
	, [REDZONE_TD] VARCHAR(50)
	, [REDZONE_EFFICIENCY] VARCHAR(50)
	, [GOAL_TO_GO_ATTEMPTS] VARCHAR(50)
	, [GOAL_TO_GO_TD] VARCHAR(50)
	, [GOAL_TO_GO_EFFICIENCY] VARCHAR(50)
	, [SAFETIES] VARCHAR(50)
	, [TURNOVERS] VARCHAR(50)
	, [POINTS_SCORED] VARCHAR(50)
	, [TIME_OF_POSSESION] VARCHAR(50)
	, [WIN_LOSS] VARCHAR(50)
	, [CREATED_DATE] VARCHAR(50)
	, [CREATE_USER] VARCHAR(50)
) ON [PRIMARY]
GO
-- Insert into landing zone from file 
BULK INSERT [PRD_LA_NFL].[DBO].[GAME_STATS]
FROM 'C:\data-directory\game_stats.csv'
WITH
(
	FIRSTROW = 2,
    FIELDTERMINATOR = ',', 
    ROWTERMINATOR = '0x0A',  
    TABLOCK
)
;
-- Create source image table
CREATE TABLE [PRD_SI_NFL].[DBO].[GAME_STATS] (
	GAME_ID INTEGER NOT NULL
	, TEAM_ID INTEGER NOT NULL
	, TOTAL_FIRST_DOWNS INTEGER NULL
	, PASSING_FIRST_DOWNS INTEGER NULL
	, RUSHING_FIRST_DOWNS INTEGER NULL
	, PENALTY_FIRST_DOWNS INTEGER NULL
	, THIRD_DOWN_ATTEMPTS INTEGER NULL
	, THIRD_DOWN_CONVERSIONS INTEGER NULL
	, THIRD_DOWN_CONVERSION_PERC DECIMAL(10,5) NULL
	, THIRD_DOWN_PASSING_CONVERSIONS INTEGER NULL
	, THIRD_DOWN_RUSHING_CONVERSIONS INTEGER NULL
	, THIRD_DOWN_PENALTY_CONVERSIONS INTEGER NULL
	, FOURTH_DOWN_ATTEMPTS INTEGER NULL
	, FOURTH_DOWN_CONVERSIONS INTEGER NULL
	, FOURTH_DOWN_CONVERSION_PERC DECIMAL(10,5) NULL
	, FOURTH_DOWN_PASSING_CONVERSIONS INTEGER NULL
	, FOURTH_DOWN_RUSHING_CONVERSIONS INTEGER NULL
	, FOURTH_DOWN_PENALTY_CONVERSIONS INTEGER NULL
	, TOTAL_PLAYS INTEGER NULL
	, TOTAL_YARDS INTEGER NULL
	, YARDS_PER_PLAY DECIMAL(10,5) NULL
	, RUSHING_PLAYS INTEGER NULL
	, RUSHING_YARDS INTEGER NULL
	, RUSHING_YARDS_PER_PLAY DECIMAL(10,5) NULL
	, PASSING_PLAYS INTEGER NULL
	, PASSING_COMPLETIONS INTEGER NULL
	, PASSING_YARDS_PER_PLAY DECIMAL(10,5) NULL
	, INTERCEPTIONS INTEGER NULL
	, SACKS INTEGER NULL
	, NET_PASSING_YARDS INTEGER NULL
	, GROSS_PASSING_YARDS INTEGER NULL
	, SACK_YARDS INTEGER NULL
	, TOTAL_RETURN_YARDS INTEGER NULL
	, PUNT_RETURNS INTEGER NULL
	, PUNT_RETURN_YARDS INTEGER NULL
	, KICK_OFF_RETURNS INTEGER NULL
	, KICK_OFF_RETURN_YARDS INTEGER NULL
	, INTERCEPTION_RETURNS INTEGER NULL
	, INTERCEPTION_RETURN_YARDS INTEGER NULL
	, KICK_OFFS INTEGER NULL
	, KICK_OFFS_IN_ENDZONE INTEGER NULL
	, TOUCHBACKS INTEGER NULL
	, PUNTS INTEGER NULL
	, AVERAGE_PUNT_YARDS DECIMAL(10,5) NULL
	, PUNTS_BLOCKED INTEGER NULL
	, AVERAGE_NET_PUNT_YARDS DECIMAL(10,5) NULL
	, PENALTIES INTEGER NULL
	, PENALTY_YARDS INTEGER NULL
	, FUMBLES INTEGER NULL
	, FUMBLES_LOST INTEGER NULL
	, TOTAL_TD INTEGER NULL
	, PASSING_TD INTEGER NULL
	, RUSHING_TD INTEGER NULL
	, INTERCEPTION_TD INTEGER NULL
	, FUMBLE_TD INTEGER NULL
	, PUNT_RETURN_TD INTEGER NULL
	, KICK_OFF_RETURN_TD INTEGER NULL
	, FIELD_GOAL_RETURN_TD INTEGER NULL
	, EXTRA_POINT_ATTEMPTS INTEGER NULL
	, EXTRA_POINTS_MADE INTEGER NULL
	, EXTRA_POINTS_BLOCKED INTEGER NULL
	, TWO_POINT_CONVERSION_ATTEMPTS INTEGER NULL
	, TWO_POINT_CONVERSIONS_MADE INTEGER NULL
	, FIELD_GOAL_ATTEMPTS INTEGER NULL
	, FIELD_GOALS_MADE INTEGER NULL
	, FIELD_GOALS_BLOCKED INTEGER NULL
	, REDZONE_VISITS INTEGER NULL
	, REDZONE_TD INTEGER NULL
	, REDZONE_EFFICIENCY DECIMAL(10,5) NULL
	, GOAL_TO_GO_ATTEMPTS INTEGER NULL
	, GOAL_TO_GO_TD INTEGER NULL
	, GOAL_TO_GO_EFFICIENCY INTEGER NULL
	, SAFETIES INTEGER NULL
	, TURNOVERS INTEGER NULL
	, POINTS_SCORED INTEGER NULL
	, TIME_OF_POSSESION VARCHAR(8) NULL
	, WIN_LOSS CHAR(1) NULL
	, CREATED_DATE DATETIMEOFFSET NULL
	, CREATE_USER  VARCHAR(50) NULL
	, CONSTRAINT FK_GAME_STATS_GAME_ID FOREIGN KEY ([GAME_ID])
		REFERENCES [dbo].[GAME] ([GAME_ID])
	, CONSTRAINT FK_GAME_STATS_TEAM_ID FOREIGN KEY ([TEAM_ID])
		REFERENCES [dbo].[TEAM_LOOKUP] ([TEAM_ID])
) ON [PRIMARY]
GO
-- Transform from landing into source image with correct data types
INSERT INTO [PRD_SI_NFL].[DBO].[GAME_STATS]
SELECT	CAST(CAST([GAME_ID] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TEAM_ID] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TOTAL_FIRST_DOWNS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([PASSING_FIRST_DOWNS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([RUSHING_FIRST_DOWNS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([PENALTY_FIRST_DOWNS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([THIRD_DOWN_ATTEMPTS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([THIRD_DOWN_CONVERSIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST([THIRD_DOWN_CONVERSION_PERC] AS DECIMAL(10,5))
		, CAST(CAST([THIRD_DOWN_PASSING_CONVERSIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([THIRD_DOWN_RUSHING_CONVERSIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([THIRD_DOWN_PENALTY_CONVERSIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FOURTH_DOWN_ATTEMPTS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FOURTH_DOWN_CONVERSIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST([FOURTH_DOWN_CONVERSION_PERC] AS DECIMAL(10,5))
		, CAST(CAST([FOURTH_DOWN_PASSING_CONVERSIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FOURTH_DOWN_RUSHING_CONVERSIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FOURTH_DOWN_PENALTY_CONVERSIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TOTAL_PLAYS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TOTAL_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST([YARDS_PER_PLAY] AS DECIMAL(10,5))
		, CAST(CAST([RUSHING_PLAYS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([RUSHING_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST([RUSHING_YARDS_PER_PLAY] AS DECIMAL(10,5))
		, CAST(CAST([PASSING_PLAYS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([PASSING_COMPLETIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST([PASSING_YARDS_PER_PLAY] AS DECIMAL(10,5))
		, CAST(CAST([INTERCEPTIONS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([SACKS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([NET_PASSING_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([GROSS_PASSING_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([SACK_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TOTAL_RETURN_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([PUNT_RETURNS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([PUNT_RETURN_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([KICK_OFF_RETURNS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([KICK_OFF_RETURN_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([INTERCEPTION_RETURNS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([INTERCEPTION_RETURN_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([KICK_OFFS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([KICK_OFFS_IN_ENDZONE] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TOUCHBACKS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([PUNTS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST([AVERAGE_PUNT_YARDS] AS DECIMAL(10,5))
		, CAST(CAST([PUNTS_BLOCKED] AS DECIMAL(15,6)) AS INTEGER)
		, CAST([AVERAGE_NET_PUNT_YARDS] AS DECIMAL(10,5))
		, CAST(CAST([PENALTIES] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([PENALTY_YARDS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FUMBLES] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FUMBLES_LOST] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TOTAL_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([PASSING_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([RUSHING_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([INTERCEPTION_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FUMBLE_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([PUNT_RETURN_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([KICK_OFF_RETURN_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FIELD_GOAL_RETURN_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([EXTRA_POINT_ATTEMPTS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([EXTRA_POINTS_MADE] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([EXTRA_POINTS_BLOCKED] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TWO_POINT_CONVERSION_ATTEMPTS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TWO_POINT_CONVERSIONS_MADE] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FIELD_GOAL_ATTEMPTS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FIELD_GOALS_MADE] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([FIELD_GOALS_BLOCKED] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([REDZONE_VISITS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([REDZONE_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST([REDZONE_EFFICIENCY] AS DECIMAL(10,5))
		, CAST(CAST([GOAL_TO_GO_ATTEMPTS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([GOAL_TO_GO_TD] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([GOAL_TO_GO_EFFICIENCY] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([SAFETIES] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([TURNOVERS] AS DECIMAL(15,6)) AS INTEGER)
		, CAST(CAST([POINTS_SCORED] AS DECIMAL(15,6)) AS INTEGER)
		, CASE 
			WHEN REPLACE([WIN_LOSS], '"', '')='T' THEN
				NULL
			ELSE
				REPLACE([TIME_OF_POSSESION], '"', '') 
		END
		, REPLACE([WIN_LOSS], '"', '')
		, CAST(REPLACE([CREATED_DATE], '"', '') AS DATETIMEOFFSET)
		, REPLACE(REPLACE([CREATE_USER], '"', ''), ',', '')
FROM	[PRD_LA_NFL].[DBO].[GAME_STATS]
;
SELECT GETDATE() AS TimeOfQuery